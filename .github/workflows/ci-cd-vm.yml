name: MetaStackerBandit VM Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggers

env:
  VM_HOST: 172.191.90.145
  VM_USER: azureuser
  VM_SSH_KEY: ${{ secrets.VM_SSH_PRIVATE_KEY }}
  PROJECT_DIR: /home/azureuser/MetaStackerBandit
  PYTHON_VERSION: '3.10'  # Ubuntu 22.04 default, or 3.12 via deadsnakes PPA on VM

jobs:
  # Job 1: Build Frontend and Test
  build-and-test:
    runs-on: ubuntu-latest
    name: Build Frontend and Test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # Install build dependencies first to ensure wheels can be built if needed
        pip install --only-binary :all: numpy pandas || pip install numpy pandas
        pip install -r requirements.txt

    - name: Test module imports
      run: |
        python -c "
        try:
            import live_demo.main
            print('‚úÖ live_demo.main imported')
        except Exception as e:
            print(f'‚ö†Ô∏è live_demo.main: {e}')
        try:
            import live_demo_1h.main
            print('‚úÖ live_demo_1h.main imported')
        except Exception as e:
            print(f'‚ö†Ô∏è live_demo_1h.main: {e}')
        try:
            import live_demo_12h.main
            print('‚úÖ live_demo_12h.main imported')
        except Exception as e:
            print(f'‚ö†Ô∏è live_demo_12h.main: {e}')
        try:
            import live_demo_24h.main
            print('‚úÖ live_demo_24h.main imported')
        except Exception as e:
            print(f'‚ùå live_demo_24h.main: {e}')
            exit(1)
        import requests
        print('‚úÖ All modules import successfully')
        "

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Build React frontend (for testing)
      working-directory: ./frontend
      env:
        REACT_APP_API_URL: ''
        REACT_APP_DASHBOARD_PASSWORD: ${{ secrets.DASHBOARD_PASSWORD || 'metastacker2024' }}
      run: npm run build
      # Note: This build is just for testing. The actual build happens on VM.

  # Job 2: Deploy to Azure VM
  deploy-vm:
    runs-on: ubuntu-latest
    name: Deploy to Azure VM
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/vm_key
        chmod 600 ~/.ssh/vm_key
        ssh-keyscan -H ${{ env.VM_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to VM
      run: |
        ssh -i ~/.ssh/vm_key -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} << EOF
        set -e
        
        # Check if repository exists, clone if not
        if [ ! -d "${{ env.PROJECT_DIR }}/.git" ]; then
            echo "üì• Repository not found, cloning..."
            mkdir -p ${{ env.PROJECT_DIR }}
            cd ${{ env.PROJECT_DIR }}
            # Use GitHub Actions token for private repo access
            git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git .
        else
            echo "üì• Pulling latest code..."
            cd ${{ env.PROJECT_DIR }}
            # Configure git to use token for private repo
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git fetch origin
        fi
        
        # Stash any local changes to data directories (safety measure)
        echo "üíæ Preserving bot data directories..."
        mkdir -p /tmp/vm_data_backup
        if [ -d "paper_trading_outputs" ]; then
            echo "   Backing up paper_trading_outputs..."
            cp -r paper_trading_outputs /tmp/vm_data_backup/ 2>/dev/null || true
        fi
        if [ -d "logs" ]; then
            echo "   Backing up logs..."
            cp -r logs /tmp/vm_data_backup/ 2>/dev/null || true
        fi
        
        # Reset code (but preserve untracked/ignored files)
        git reset --hard origin/main
        git clean -fd --exclude='paper_trading_outputs' --exclude='logs' --exclude='.env' || true
        
        # Restore data directories if they were backed up
        if [ -d "/tmp/vm_data_backup/paper_trading_outputs" ]; then
            echo "   Restoring paper_trading_outputs..."
            rm -rf paper_trading_outputs
            mv /tmp/vm_data_backup/paper_trading_outputs ./
        fi
        if [ -d "/tmp/vm_data_backup/logs" ]; then
            echo "   Restoring logs..."
            rm -rf logs
            mv /tmp/vm_data_backup/logs ./
        fi
        rm -rf /tmp/vm_data_backup
        
        echo "‚úÖ Code updated, bot data preserved"
        
        echo "üîß Installing system dependencies (if needed)..."
        sudo apt-get update -qq
        
        # Install Python 3.12 from deadsnakes PPA (Ubuntu 22.04 doesn't have 3.12 in default repos)
        echo "   Adding deadsnakes PPA for Python 3.12..."
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository -y ppa:deadsnakes/ppa 2>/dev/null || {
            echo "   PPA already added or failed, continuing..."
        }
        sudo apt-get update -qq
        
        # Try to install Python 3.12, fallback to system Python 3.10
        if sudo apt-get install -y python3.12 python3.12-venv python3.12-distutils 2>/dev/null; then
            echo "‚úÖ Python 3.12 installed from deadsnakes PPA"
            PYTHON_VER="3.12"
        else
            echo "‚ö†Ô∏è  Python 3.12 not available, using system Python 3.10"
            sudo apt-get install -y python3 python3-venv
            PYTHON_VER="3"
        fi
        
        # Install other dependencies (fix Node.js/npm conflict by installing nodejs-legacy or using nodejs from NodeSource)
        echo "   Installing build tools and Node.js..."
        # Remove conflicting npm/nodejs packages first
        sudo apt-get remove -y nodejs npm 2>/dev/null || true
        # Install Node.js 18.x from NodeSource (better compatibility)
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - 2>/dev/null || {
            echo "   NodeSource setup failed, using default nodejs..."
            sudo apt-get install -y nodejs npm
        }
        sudo apt-get install -y nodejs python3-pip build-essential git curl
        
        echo "üîÑ Setting up Python environment..."
        # Determine which Python to use
        USE_VENV=false
        if [ "$PYTHON_VER" = "3.12" ] && command -v python3.12 &> /dev/null; then
            PYTHON_CMD_VENV="python3.12"
        elif command -v python3.11 &> /dev/null; then
            PYTHON_CMD_VENV="python3.11"
        else
            PYTHON_CMD_VENV="python3"
        fi
        
        if [ ! -d "venv" ]; then
            echo "   Attempting to create virtual environment with $PYTHON_CMD_VENV..."
            if $PYTHON_CMD_VENV -m venv venv 2>/dev/null && [ -f "venv/bin/activate" ]; then
                echo "‚úÖ Virtual environment created"
                USE_VENV=true
            else
                echo "‚ö†Ô∏è  Virtual environment creation failed, using system Python"
                USE_VENV=false
            fi
        elif [ -f "venv/bin/activate" ]; then
            echo "‚úÖ Virtual environment already exists"
            USE_VENV=true
        else
            echo "‚ö†Ô∏è  Existing venv directory invalid, using system Python"
            USE_VENV=false
        fi
        
        if [ "$USE_VENV" = "true" ]; then
            echo "   Activating virtual environment..."
            source venv/bin/activate
            PYTHON_CMD="python"
            PIP_CMD="pip"
        else
            echo "   Using system Python (python3/pip3)"
            PYTHON_CMD="python3"
            PIP_CMD="pip3"
        fi
        
        echo "üì¶ Updating Python dependencies..."
        # Upgrade pip (try with --user if permission denied)
        $PIP_CMD install -q --upgrade pip setuptools wheel 2>/dev/null || $PIP_CMD install -q --upgrade pip setuptools wheel --user 2>/dev/null || echo "‚ö†Ô∏è  pip upgrade failed, continuing..."
        # Install numpy and pandas first (they may need to build from source on some systems)
        echo "   Installing numpy and pandas (may take a few minutes)..."
        $PIP_CMD install -q numpy pandas 2>/dev/null || $PIP_CMD install -q numpy pandas --user 2>/dev/null || {
            echo "‚ö†Ô∏è  numpy/pandas install had issues, continuing with full requirements..."
        }
        # Install requirements (try with --user if permission denied)
        $PIP_CMD install -q -r requirements.txt 2>/dev/null || $PIP_CMD install -q -r requirements.txt --user 2>/dev/null || {
            echo "‚ùå Failed to install Python dependencies"
            echo "   Attempting with verbose output..."
            $PIP_CMD install -r requirements.txt --user || true
        }
        
        # Install Node.js dependencies
        echo "üì¶ Installing/updating Node.js dependencies..."
        cd frontend
        # Clean install to avoid "nodepath" and other module issues
        rm -rf node_modules package-lock.json 2>/dev/null || true
        npm cache clean --force 2>/dev/null || true
        npm install
        cd ..
        
        echo "üõë Stopping existing services..."
        pkill -f "python.*start_project.py" || true
        pkill -f gunicorn || true
        pkill -f uvicorn || true
        pkill -f run_unified_bots.py || true
        sleep 2
        
        # Ensure necessary directories exist
        echo "üìÅ Creating necessary directories..."
        mkdir -p logs
        mkdir -p paper_trading_outputs/sheets_fallback
        
        echo "üöÄ Starting application with start_project.py..."
        # Use start_project.py with production flags:
        # --gunicorn: Use gunicorn with multiple workers for production
        # --daemon: Run in background mode
        # Frontend will auto-rebuild if source files changed
        # Use the correct Python command (venv or system)
        nohup $PYTHON_CMD start_project.py --gunicorn --daemon > logs/start_project.log 2>&1 &
        
        echo "‚úÖ Deployment complete!"
        EOF

    - name: Verify Deployment
      run: |
        echo "üîç Verifying deployment..."
        sleep 10
        
        # Wait for app to start
        echo "‚è≥ Waiting for application to start..."
        sleep 15
        
        # Try health check with retries (give more time for start_project.py to build frontend)
        for i in {1..8}; do
          if ssh -i ~/.ssh/vm_key -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} "curl -f -s http://localhost:8000/api/health > /dev/null 2>&1"; then
            echo "‚úÖ Health check passed!"
            break
          else
            echo "‚è≥ Health check attempt $i/8 failed, retrying in 10 seconds..."
            echo "   (start_project.py may be building frontend or starting services...)"
            sleep 10
          fi
        done
        
        # Final check
        if ssh -i ~/.ssh/vm_key -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} "curl -f -s http://localhost:8000/api/health > /dev/null 2>&1"; then
          echo "‚úÖ Application is healthy and ready!"
        else
          echo "‚ö†Ô∏è Health check failed, but deployment may still be starting"
          echo "   Check manually at: http://${{ env.VM_HOST }}:8000/api/health"
          echo "   Check logs: ssh ${{ env.VM_USER }}@${{ env.VM_HOST }} 'tail -f ${{ env.PROJECT_DIR }}/logs/start_project.log'"
        fi

    - name: Deployment Summary
      run: |
        echo "=========================================="
        echo "‚úÖ DEPLOYMENT COMPLETE!"
        echo "=========================================="
        echo ""
        echo "üåê APPLICATION URL:"
        echo "   http://${{ env.VM_HOST }}:8000"
        echo ""
        echo "üìã ACCESS POINTS:"
        echo "   - Frontend Dashboard: http://${{ env.VM_HOST }}:8000"
        echo "   - Backend API:        http://${{ env.VM_HOST }}:8000/api"
        echo "   - Health Check:       http://${{ env.VM_HOST }}:8000/api/health"
        echo ""
        echo "=========================================="
        
        # Create a summary for GitHub Actions UI
        echo "## üöÄ VM Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üåê Application URL" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "[**http://${{ env.VM_HOST }}:8000**](http://${{ env.VM_HOST }}:8000)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìã Access Points" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Dashboard:** [http://${{ env.VM_HOST }}:8000](http://${{ env.VM_HOST }}:8000)" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend API:** [http://${{ env.VM_HOST }}:8000/api](http://${{ env.VM_HOST }}:8000/api)" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check:** [http://${{ env.VM_HOST }}:8000/api/health](http://${{ env.VM_HOST }}:8000/api/health)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** The application may take 10-30 seconds to fully start after deployment." >> $GITHUB_STEP_SUMMARY

    - name: Wait for Bot Outputs
      run: |
        echo "‚è≥ Waiting for bots to generate initial outputs (90 seconds)..."
        sleep 90
        echo "‚úÖ Wait complete, checking for outputs..."

    - name: Download Paper Trading Outputs
      run: |
        echo "üì• Downloading paper_trading_outputs from VM..."
        
        # Create local directory for outputs
        mkdir -p paper_trading_outputs
        
        # Use tar over SSH to download the folder (most reliable method)
        # This creates a tar archive on the VM and streams it to local machine
        ssh -i ~/.ssh/vm_key -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} \
          "cd ${{ env.PROJECT_DIR }} && tar -czf - paper_trading_outputs 2>/dev/null" \
          | tar -xzf - || {
          echo "‚ö†Ô∏è Could not download outputs (may not exist yet or directory is empty)"
          # Try to check if directory exists
          ssh -i ~/.ssh/vm_key -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} \
            "test -d ${{ env.PROJECT_DIR }}/paper_trading_outputs && echo 'Directory exists' || echo 'Directory does not exist'" || true
        }
        
        # Check what we got
        if [ -d "./paper_trading_outputs" ]; then
          echo "‚úÖ Downloaded outputs structure:"
          find ./paper_trading_outputs -type f \( -name "*.jsonl.gz" -o -name "*.csv" -o -name "*.json" \) | head -30 || echo "   (no files found yet)"
          echo ""
          echo "üìä Top-level directory structure:"
          ls -la ./paper_trading_outputs/ 2>/dev/null | head -20 || echo "   (directory empty or not accessible)"
          echo ""
          echo "üìà Summary by timeframe:"
          for tf in 5m 1h 12h 24h; do
            if [ -d "./paper_trading_outputs/$tf" ]; then
              file_count=$(find "./paper_trading_outputs/$tf" -type f | wc -l)
              echo "   $tf: $file_count files"
            fi
          done
        else
          echo "‚ö†Ô∏è paper_trading_outputs directory not found on VM"
        fi

    - name: Upload Paper Trading Outputs as Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: paper_trading_outputs
        path: paper_trading_outputs/
        retention-days: 7
        if-no-files-found: warn

