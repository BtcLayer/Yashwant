name: Secret Scanning

on:
  push:
    branches: [ main, ensemble1.1 ]
  pull_request:
    branches: [ main, ensemble1.1 ]

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for Gitleaks Pro

  config-validation:
    name: Config Credential Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded credentials in configs
        run: |
          # Check for non-empty api_key/api_secret fields in config.json files
          echo "Checking config files for hardcoded credentials..."
          
          # Define pattern for suspicious strings (not empty, not env var placeholder)
          SUSPICIOUS_PATTERNS='(api_key|api_secret|private_key|service_account).*:\s*"[^$"][^"]{20,}"'
          
          if grep -rE "$SUSPICIOUS_PATTERNS" \
            --include="config.json" \
            --exclude-dir=node_modules \
            --exclude-dir=.venv \
            live_demo*/; then
            echo "‚ùå ERROR: Found hardcoded credentials in config files!"
            echo "Credentials should be:"
            echo "  1. Empty strings in config.json"
            echo "  2. Or use \${ENV_VAR} placeholders"
            echo "  3. Set via environment variables at runtime"
            exit 1
          else
            echo "‚úÖ No hardcoded credentials found in config files"
          fi

      - name: Check for service account JSON files
        run: |
          echo "Checking for committed service account keys..."
          
          # Look for service account key files
          if find . -type f -name "*.json" \
            -not -path "*/node_modules/*" \
            -not -path "*/.venv/*" \
            -not -path "*/package*.json" \
            -not -path "*/tsconfig*.json" \
            -exec grep -l '"type".*:.*"service_account"' {} \; | grep -v ".template.json"; then
            echo "‚ùå ERROR: Found committed service account key files!"
            echo "Service account keys must NEVER be committed to the repository."
            exit 1
          else
            echo "‚úÖ No service account key files found"
          fi

  result:
    name: Security Scan Result
    runs-on: ubuntu-latest
    needs: [gitleaks, config-validation]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.gitleaks.result }}" == "failure" ] || [ "${{ needs.config-validation.result }}" == "failure" ]; then
            echo "‚ùå Security scan failed! Secrets or credentials detected."
            echo ""
            echo "üîí REQUIRED ACTIONS:"
            echo "1. Remove all secrets from committed files"
            echo "2. Rotate/revoke any exposed credentials immediately"
            echo "3. Use environment variables or secret managers"
            echo "4. Review config.template.json for proper setup"
            exit 1
          else
            echo "‚úÖ Security scan passed - no secrets detected"
          fi
